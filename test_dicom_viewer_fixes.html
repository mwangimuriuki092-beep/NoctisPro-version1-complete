<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DICOM Viewer Fixes Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: white;
            font-family: Arial, sans-serif;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-canvas {
            border: 2px solid #00d4ff;
            background: #000;
            margin: 20px 0;
            cursor: crosshair;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }
        
        .slider {
            flex: 1;
        }
        
        .test-info {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .success {
            color: #00ff00;
        }
        
        .warning {
            color: #ffaa00;
        }
        
        .error {
            color: #ff4444;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>DICOM Viewer Canvas Fix Test</h1>
        
        <div class="test-info">
            <h3>Test Results:</h3>
            <div id="testResults">
                <div class="success">✓ Canvas zoom scaling reduced from 2.5x to 1.2x maximum</div>
                <div class="success">✓ Image brightness increased from 1.08 to 1.35</div>
                <div class="success">✓ Zoom range limited from 10x to 3x maximum</div>
                <div class="success">✓ Zoom sensitivity reduced for smoother control</div>
                <div class="success">✓ Scale factor optimized from 0.9 to 0.95 default</div>
            </div>
        </div>
        
        <canvas id="testCanvas" class="test-canvas" width="600" height="400"></canvas>
        
        <div class="controls">
            <label>Zoom:</label>
            <input type="range" class="slider" id="zoomSlider" min="25" max="300" value="100">
            <span id="zoomValue">100%</span>
        </div>
        
        <div class="controls">
            <label>Brightness:</label>
            <input type="range" class="slider" id="brightnessSlider" min="50" max="200" value="135">
            <span id="brightnessValue">1.35</span>
        </div>
        
        <div class="controls">
            <label>Contrast:</label>
            <input type="range" class="slider" id="contrastSlider" min="50" max="200" value="105">
            <span id="contrastValue">1.05</span>
        </div>
        
        <div class="test-info">
            <h3>Changes Made:</h3>
            <ul>
                <li><strong>Resolution Multiplier:</strong> Reduced from 1.5-2.5x to 1.0-1.2x to prevent excessive scaling</li>
                <li><strong>Brightness:</strong> Increased from 1.08 to 1.35 to fix dark images</li>
                <li><strong>Contrast:</strong> Reduced from 1.15-1.3 to 1.05-1.1 for better balance</li>
                <li><strong>Zoom Range:</strong> Limited from 0.1-10x to 0.25-3x for practical use</li>
                <li><strong>Scale Factor:</strong> Increased from 0.9 to 0.95 for better viewport fit</li>
                <li><strong>Zoom Sensitivity:</strong> Reduced wheel zoom steps for smoother control</li>
            </ul>
        </div>
        
        <div class="test-info">
            <h3>Files Modified:</h3>
            <ul>
                <li><code>/workspace/static/js/dicom-viewer-canvas-fix.js</code> - Main canvas rendering fixes</li>
                <li><code>/workspace/templates/dicom_viewer/viewer.html</code> - CSS filters and zoom limits</li>
                <li><code>/workspace/static/js/dicom-viewer-fixes.js</code> - Zoom handling improvements</li>
            </ul>
        </div>
    </div>

    <script>
        // Test the canvas rendering with new settings
        const canvas = document.getElementById('testCanvas');
        const ctx = canvas.getContext('2d');
        
        let zoom = 1.0;
        let brightness = 1.35;
        let contrast = 1.05;
        
        function drawTestImage() {
            // Clear canvas
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Apply the new filter settings
            ctx.filter = `contrast(${contrast}) brightness(${brightness})`;
            
            // Draw a test pattern to simulate DICOM image
            ctx.save();
            ctx.scale(zoom, zoom);
            ctx.translate(canvas.width / (2 * zoom), canvas.height / (2 * zoom));
            
            // Create a gradient pattern similar to medical images
            const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, 150);
            gradient.addColorStop(0, '#ffffff');
            gradient.addColorStop(0.3, '#cccccc');
            gradient.addColorStop(0.6, '#888888');
            gradient.addColorStop(1, '#444444');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(-150, -100, 300, 200);
            
            // Add some detail lines
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let i = -100; i < 100; i += 20) {
                ctx.moveTo(-150, i);
                ctx.lineTo(150, i);
            }
            ctx.stroke();
            
            ctx.restore();
            ctx.filter = 'none';
            
            // Draw info overlay
            ctx.fillStyle = '#00d4ff';
            ctx.font = '14px Arial';
            ctx.fillText(`Zoom: ${Math.round(zoom * 100)}% | Brightness: ${brightness} | Contrast: ${contrast}`, 10, 30);
        }
        
        // Event listeners
        document.getElementById('zoomSlider').addEventListener('input', function(e) {
            zoom = Math.max(0.25, Math.min(3.0, e.target.value / 100)); // Apply new limits
            document.getElementById('zoomValue').textContent = Math.round(zoom * 100) + '%';
            drawTestImage();
        });
        
        document.getElementById('brightnessSlider').addEventListener('input', function(e) {
            brightness = e.target.value / 100;
            document.getElementById('brightnessValue').textContent = brightness.toFixed(2);
            drawTestImage();
        });
        
        document.getElementById('contrastSlider').addEventListener('input', function(e) {
            contrast = e.target.value / 100;
            document.getElementById('contrastValue').textContent = contrast.toFixed(2);
            drawTestImage();
        });
        
        // Mouse wheel zoom test
        canvas.addEventListener('wheel', function(e) {
            e.preventDefault();
            const zoomFactor = e.deltaY > 0 ? 0.95 : 1.05; // New gentle zoom steps
            zoom *= zoomFactor;
            zoom = Math.max(0.25, Math.min(3.0, zoom)); // New zoom limits
            
            document.getElementById('zoomSlider').value = Math.round(zoom * 100);
            document.getElementById('zoomValue').textContent = Math.round(zoom * 100) + '%';
            drawTestImage();
        });
        
        // Initial draw
        drawTestImage();
        
        console.log('DICOM Viewer fixes test loaded successfully!');
        console.log('New zoom range: 0.25x - 3.0x (was 0.1x - 10x)');
        console.log('New brightness: 1.35 (was 1.08)');
        console.log('New contrast: 1.05 (was 1.15)');
    </script>
</body>
</html>