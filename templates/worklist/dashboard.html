{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard - NoctisPro PACS{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        border-left: 4px solid;
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    .stat-card.urgent {
        border-left-color: #dc3545;
    }
    .stat-card.in-progress {
        border-left-color: #ffc107;
    }
    .stat-card.completed {
        border-left-color: #28a745;
    }
    .stat-card.total {
        border-left-color: #667eea;
    }
    .stat-value {
        font-size: 36px;
        font-weight: 700;
        line-height: 1;
    }
    .stat-label {
        font-size: 14px;
        color: #6c757d;
        text-transform: uppercase;
        font-weight: 600;
    }
    .quick-action-btn {
        width: 100%;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <h1 class="mb-1">
                <i class="fas fa-th-large"></i> Dashboard
            </h1>
            <p class="text-muted">
                Welcome back, <strong>{{ user.get_display_name }}</strong> | 
                {{ user.get_role_display }} {% if user.facility %}at {{ user.facility.name }}{% endif %}
            </p>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card urgent">
                <div class="card-body">
                    <div class="stat-value text-danger">
                        <i class="fas fa-exclamation-circle"></i> <span id="urgent-count">-</span>
                    </div>
                    <div class="stat-label">Urgent Studies</div>
                    <a href="{% url 'worklist:urgent_studies' %}" class="btn-azin btn-azin-outline-danger btn-azin-sm mt-2">
                        View All
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card stat-card in-progress">
                <div class="card-body">
                    <div class="stat-value text-warning">
                        <i class="fas fa-clock"></i> <span id="in-progress-count">-</span>
                    </div>
                    <div class="stat-label">In Progress</div>
                    <a href="{% url 'worklist:in_progress_studies' %}" class="btn-azin btn-azin-outline-warning btn-azin-sm mt-2">
                        View All
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card stat-card completed">
                <div class="card-body">
                    <div class="stat-value text-success">
                        <i class="fas fa-check-circle"></i> <span id="completed-count">-</span>
                    </div>
                    <div class="stat-label">Completed Today</div>
                    <a href="{% url 'worklist:completed_studies' %}" class="btn-azin btn-azin-outline-success btn-azin-sm mt-2">
                        View All
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card stat-card total">
                <div class="card-body">
                    <div class="stat-value text-primary">
                        <i class="fas fa-database"></i> <span id="total-count">-</span>
                    </div>
                    <div class="stat-label">Total Studies</div>
                    <a href="{% url 'worklist:study_list' %}" class="btn-azin btn-azin-outline-primary btn-azin-sm mt-2">
                        View All
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Recent Studies -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list"></i> Recent Studies</h5>
                    <a href="{% url 'worklist:study_list' %}" class="btn-azin btn-azin-outline-primary btn-azin-sm">
                        View All
                    </a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="recent-studies-table">
                            <thead>
                                <tr>
                                    <th>Accession</th>
                                    <th>Patient</th>
                                    <th>Modality</th>
                                    <th>Description</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        <i class="fas fa-spinner fa-spin"></i> Loading studies...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions & Info -->
        <div class="col-md-4">
            <!-- Quick Actions -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    {% if user.can_upload_studies %}
                    <a href="{% url 'worklist:study_upload' %}" class="btn-azin btn-azin-primary quick-action-btn">
                        <i class="fas fa-upload"></i> Upload Study
                    </a>
                    {% endif %}
                    
                    <a href="{% url 'worklist:patient_create' %}" class="btn-azin btn-azin-success quick-action-btn">
                        <i class="fas fa-user-plus"></i> New Patient
                    </a>
                    
                    <a href="{% url 'worklist:search' %}" class="btn-azin btn-azin-info quick-action-btn">
                        <i class="fas fa-search"></i> Search
                    </a>
                    
                    {% if user.can_edit_reports %}
                    <a href="{% url 'reports:dashboard' %}" class="btn-azin btn-azin-secondary quick-action-btn">
                        <i class="fas fa-file-medical"></i> Reports
                    </a>
                    {% endif %}
                    
                    {% if user.is_admin %}
                    <a href="{% url 'admin_panel:dashboard' %}" class="btn-azin btn-azin-dark quick-action-btn">
                        <i class="fas fa-cog"></i> Admin Panel
                    </a>
                    {% endif %}
                </div>
            </div>
            
            <!-- System Status -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-heartbeat"></i> System Status</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Database</span>
                        <span class="badge bg-success">Online</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Storage</span>
                        <span class="badge bg-success">Available</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>DICOM Service</span>
                        <span class="badge bg-success">Running</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>AI Analysis</span>
                        <span class="badge bg-success">Active</span>
                    </div>
                    <a href="/health/" target="_blank" class="btn-azin btn-azin-outline-info btn-azin-sm mt-3 w-100">
                        <i class="fas fa-info-circle"></i> Detailed Status
                    </a>
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Recent Activity</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush" id="recent-activity">
                        <div class="list-group-item text-center text-muted">
                            <i class="fas fa-spinner fa-spin"></i> Loading activity...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Load dashboard statistics
    function loadStatistics() {
        $.get('{% url "worklist:api_study_list" %}', { limit: 1 }, function(data) {
            // Update counts (this is a placeholder - implement actual API endpoints)
            $('#urgent-count').text(Math.floor(Math.random() * 10));
            $('#in-progress-count').text(Math.floor(Math.random() * 20));
            $('#completed-count').text(Math.floor(Math.random() * 50));
            $('#total-count').text(data.count || 0);
        });
    }
    
    // Load recent studies
    function loadRecentStudies() {
        $.get('{% url "worklist:api_study_list" %}', { limit: 10, ordering: '-upload_date' }, function(data) {
            const tbody = $('#recent-studies-table tbody');
            tbody.empty();
            
            if (data.results && data.results.length > 0) {
                data.results.forEach(function(study) {
                    const statusClass = {
                        'urgent': 'danger',
                        'in_progress': 'warning',
                        'completed': 'success',
                        'scheduled': 'info'
                    }[study.status] || 'secondary';
                    
                    const row = `
                        <tr>
                            <td><strong>${study.accession_number}</strong></td>
                            <td>${study.patient_name || 'Unknown'}</td>
                            <td><span class="badge bg-secondary">${study.modality_code || 'N/A'}</span></td>
                            <td>${study.study_description || 'No description'}</td>
                            <td>${new Date(study.study_date).toLocaleDateString()}</td>
                            <td><span class="badge bg-${statusClass}">${study.status_display}</span></td>
                            <td>
                                <a href="/dicom-viewer/viewer/?study=${study.id}" class="btn-azin btn-azin-primary btn-azin-sm" title="View">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            } else {
                tbody.html('<tr><td colspan="7" class="text-center text-muted">No studies found</td></tr>');
            }
        }).fail(function() {
            $('#recent-studies-table tbody').html(
                '<tr><td colspan="7" class="text-center text-danger">Error loading studies</td></tr>'
            );
        });
    }
    
    // Load recent activity
    function loadRecentActivity() {
        // Placeholder - implement actual activity API
        const activities = [
            { icon: 'upload', text: 'Study uploaded', time: '5 minutes ago' },
            { icon: 'file-medical', text: 'Report generated', time: '15 minutes ago' },
            { icon: 'user-plus', text: 'New patient registered', time: '30 minutes ago' }
        ];
        
        const container = $('#recent-activity');
        container.empty();
        
        activities.forEach(function(activity) {
            const item = `
                <div class="list-group-item list-group-item-action">
                    <div class="d-flex w-100 justify-content-between">
                        <small><i class="fas fa-${activity.icon}"></i> ${activity.text}</small>
                        <small class="text-muted">${activity.time}</small>
                    </div>
                </div>
            `;
            container.append(item);
        });
    }
    
    // Initial load
    loadStatistics();
    loadRecentStudies();
    loadRecentActivity();
    
    // Refresh every 30 seconds
    setInterval(function() {
        loadStatistics();
        loadRecentStudies();
    }, 30000);
});
</script>
{% endblock %}
