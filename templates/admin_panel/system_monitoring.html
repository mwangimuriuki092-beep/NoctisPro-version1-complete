{% extends 'base_admin.html' %}

{% block title %}System Monitoring - Admin Panel{% endblock %}

{% block extra_css %}
<style>
    .monitoring-dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .metric-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        position: relative;
        overflow: hidden;
    }
    
    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: var(--accent-color);
    }
    
    .metric-card.warning::before {
        background: var(--warning-color);
    }
    
    .metric-card.critical::before {
        background: var(--danger-color);
    }
    
    .metric-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .metric-title {
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .metric-status {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-healthy {
        background: rgba(0, 255, 136, 0.2);
        color: var(--success-color);
    }
    
    .status-warning {
        background: rgba(255, 170, 0, 0.2);
        color: var(--warning-color);
    }
    
    .status-critical {
        background: rgba(255, 68, 68, 0.2);
        color: var(--danger-color);
    }
    
    .metric-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--accent-color);
        margin-bottom: 8px;
    }
    
    .metric-description {
        color: var(--text-secondary);
        font-size: 12px;
        margin-bottom: 15px;
    }
    
    .progress-bar {
        width: 100%;
        height: 8px;
        background: var(--secondary-bg);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 8px;
    }
    
    .progress-fill {
        height: 100%;
        background: var(--accent-color);
        transition: width 0.3s ease;
        border-radius: 4px;
    }
    
    .progress-fill.warning {
        background: var(--warning-color);
    }
    
    .progress-fill.critical {
        background: var(--danger-color);
    }
    
    .metric-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        font-size: 11px;
        color: var(--text-secondary);
    }
    
    .detail-item {
        display: flex;
        justify-content: space-between;
    }
    
    .system-overview {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .overview-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    
    .overview-stat {
        text-align: center;
        padding: 15px;
        background: var(--secondary-bg);
        border-radius: 6px;
    }
    
    .overview-value {
        font-size: 20px;
        font-weight: 600;
        color: var(--accent-color);
    }
    
    .overview-label {
        font-size: 11px;
        color: var(--text-secondary);
        text-transform: uppercase;
        margin-top: 5px;
    }
    
    .refresh-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--accent-color);
        color: var(--primary-bg);
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .refresh-indicator.show {
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-header">
    <h2>üìä System Monitoring Dashboard</h2>
    <div style="color: var(--text-secondary); font-size: 12px;">
        Real-time system health and performance metrics
    </div>
</div>

<div class="refresh-indicator" id="refreshIndicator">
    <i class="fas fa-sync-alt fa-spin"></i> Refreshing...
</div>

{% if metrics.health_status != 'error' %}
<div class="system-overview">
    <h3>üè• System Overview</h3>
    <div class="overview-stats">
        <div class="overview-stat">
            <div class="overview-value">{{ metrics.system.uptime.days }}</div>
            <div class="overview-label">Days Uptime</div>
        </div>
        <div class="overview-stat">
            <div class="overview-value">{{ metrics.medical_data.total_studies }}</div>
            <div class="overview-label">Total Studies</div>
        </div>
        <div class="overview-stat">
            <div class="overview-value">{{ metrics.medical_data.total_images }}</div>
            <div class="overview-label">DICOM Images</div>
        </div>
        <div class="overview-stat">
            <div class="overview-value">{{ metrics.users.active_sessions }}</div>
            <div class="overview-label">Active Users</div>
        </div>
        <div class="overview-stat">
            <div class="overview-value">{{ metrics.database.query_response_time_ms }}ms</div>
            <div class="overview-label">DB Response</div>
        </div>
        <div class="overview-stat">
            <div class="overview-value">{{ metrics.system.disk.free_gb }}GB</div>
            <div class="overview-label">Free Space</div>
        </div>
    </div>
</div>

<div class="monitoring-dashboard">
    <!-- CPU Metrics -->
    <div class="metric-card {% if metrics.system.cpu_percent > 80 %}critical{% elif metrics.system.cpu_percent > 60 %}warning{% endif %}">
        <div class="metric-header">
            <div class="metric-title">
                <i class="fas fa-microchip"></i> CPU Usage
            </div>
            <div class="metric-status status-{% if metrics.system.cpu_percent > 80 %}critical{% elif metrics.system.cpu_percent > 60 %}warning{% else %}healthy{% endif %}">
                {% if metrics.system.cpu_percent > 80 %}Critical{% elif metrics.system.cpu_percent > 60 %}Warning{% else %}Healthy{% endif %}
            </div>
        </div>
        
        <div class="metric-value">{{ metrics.system.cpu_percent }}%</div>
        <div class="metric-description">{{ metrics.system.cpu_count }} cores available</div>
        
        <div class="progress-bar">
            <div class="progress-fill {% if metrics.system.cpu_percent > 80 %}critical{% elif metrics.system.cpu_percent > 60 %}warning{% endif %}" 
                 style="width: {{ metrics.system.cpu_percent }}%"></div>
        </div>
        
        <div class="metric-details">
            <div class="detail-item">
                <span>Load Average:</span>
                <span>{{ metrics.system.load_average.0|floatformat:2 }}</span>
            </div>
            <div class="detail-item">
                <span>Cores:</span>
                <span>{{ metrics.system.cpu_count }}</span>
            </div>
        </div>
    </div>
    
    <!-- Memory Metrics -->
    <div class="metric-card {% if metrics.system.memory.percent > 85 %}critical{% elif metrics.system.memory.percent > 70 %}warning{% endif %}">
        <div class="metric-header">
            <div class="metric-title">
                <i class="fas fa-memory"></i> Memory Usage
            </div>
            <div class="metric-status status-{% if metrics.system.memory.percent > 85 %}critical{% elif metrics.system.memory.percent > 70 %}warning{% else %}healthy{% endif %}">
                {% if metrics.system.memory.percent > 85 %}Critical{% elif metrics.system.memory.percent > 70 %}Warning{% else %}Healthy{% endif %}
            </div>
        </div>
        
        <div class="metric-value">{{ metrics.system.memory.percent }}%</div>
        <div class="metric-description">{{ metrics.system.memory.used_gb }}GB of {{ metrics.system.memory.total_gb }}GB used</div>
        
        <div class="progress-bar">
            <div class="progress-fill {% if metrics.system.memory.percent > 85 %}critical{% elif metrics.system.memory.percent > 70 %}warning{% endif %}" 
                 style="width: {{ metrics.system.memory.percent }}%"></div>
        </div>
        
        <div class="metric-details">
            <div class="detail-item">
                <span>Available:</span>
                <span>{{ metrics.system.memory.available_gb }}GB</span>
            </div>
            <div class="detail-item">
                <span>Total:</span>
                <span>{{ metrics.system.memory.total_gb }}GB</span>
            </div>
        </div>
    </div>
    
    <!-- Disk Storage -->
    <div class="metric-card {% if metrics.system.disk.percent > 90 %}critical{% elif metrics.system.disk.percent > 80 %}warning{% endif %}">
        <div class="metric-header">
            <div class="metric-title">
                <i class="fas fa-hdd"></i> Disk Storage
            </div>
            <div class="metric-status status-{% if metrics.system.disk.percent > 90 %}critical{% elif metrics.system.disk.percent > 80 %}warning{% else %}healthy{% endif %}">
                {% if metrics.system.disk.percent > 90 %}Critical{% elif metrics.system.disk.percent > 80 %}Warning{% else %}Healthy{% endif %}
            </div>
        </div>
        
        <div class="metric-value">{{ metrics.system.disk.percent }}%</div>
        <div class="metric-description">{{ metrics.system.disk.used_gb }}GB of {{ metrics.system.disk.total_gb }}GB used</div>
        
        <div class="progress-bar">
            <div class="progress-fill {% if metrics.system.disk.percent > 90 %}critical{% elif metrics.system.disk.percent > 80 %}warning{% endif %}" 
                 style="width: {{ metrics.system.disk.percent }}%"></div>
        </div>
        
        <div class="metric-details">
            <div class="detail-item">
                <span>Free Space:</span>
                <span>{{ metrics.system.disk.free_gb }}GB</span>
            </div>
            <div class="detail-item">
                <span>DICOM Data:</span>
                <span>{{ metrics.storage.dicom_storage.total_size_gb|default:"0" }}GB</span>
            </div>
        </div>
    </div>
    
    <!-- Database Performance -->
    <div class="metric-card {% if metrics.database.query_response_time_ms > 100 %}warning{% endif %}">
        <div class="metric-header">
            <div class="metric-title">
                <i class="fas fa-database"></i> Database
            </div>
            <div class="metric-status status-{% if metrics.database.query_response_time_ms > 100 %}warning{% else %}healthy{% endif %}">
                {{ metrics.database.connection_status|title }}
            </div>
        </div>
        
        <div class="metric-value">{{ metrics.database.query_response_time_ms }}ms</div>
        <div class="metric-description">Average query response time</div>
        
        <div class="metric-details">
            <div class="detail-item">
                <span>Engine:</span>
                <span>{{ metrics.database.engine|slice:":-1"|split:"."|-1|title }}</span>
            </div>
            <div class="detail-item">
                <span>Host:</span>
                <span>{{ metrics.database.host }}</span>
            </div>
            {% if metrics.database.database_size %}
            <div class="detail-item">
                <span>DB Size:</span>
                <span>{{ metrics.database.database_size }}</span>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Medical Data Metrics -->
    <div class="metric-card">
        <div class="metric-header">
            <div class="metric-title">
                <i class="fas fa-file-medical"></i> Medical Data
            </div>
            <div class="metric-status status-healthy">Active</div>
        </div>
        
        <div class="metric-value">{{ metrics.medical_data.total_studies }}</div>
        <div class="metric-description">Total studies in system</div>
        
        <div class="metric-details">
            <div class="detail-item">
                <span>DICOM Images:</span>
                <span>{{ metrics.medical_data.total_images }}</span>
            </div>
            <div class="detail-item">
                <span>Avg Images/Study:</span>
                <span>{{ metrics.medical_data.avg_images_per_study }}</span>
            </div>
            <div class="detail-item">
                <span>Recent (24h):</span>
                <span>{{ metrics.medical_data.recent_studies_24h }}</span>
            </div>
            <div class="detail-item">
                <span>Compliance:</span>
                <span style="color: var(--success-color);">‚úÖ DICOM</span>
            </div>
        </div>
    </div>
    
    <!-- User Activity -->
    <div class="metric-card">
        <div class="metric-header">
            <div class="metric-title">
                <i class="fas fa-users"></i> User Activity
            </div>
            <div class="metric-status status-healthy">Active</div>
        </div>
        
        <div class="metric-value">{{ metrics.users.active_sessions }}</div>
        <div class="metric-description">Currently active sessions</div>
        
        <div class="metric-details">
            <div class="detail-item">
                <span>Total Users:</span>
                <span>{{ metrics.users.total_users }}</span>
            </div>
            <div class="detail-item">
                <span>Recent Logins:</span>
                <span>{{ metrics.users.recent_logins_24h }}</span>
            </div>
            {% for role, count in metrics.users.role_distribution.items %}
            <div class="detail-item">
                <span>{{ role|title }}s:</span>
                <span>{{ count }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Modality Distribution Chart -->
{% if metrics.medical_data.modality_distribution %}
<div class="metric-card" style="grid-column: 1 / -1;">
    <div class="metric-header">
        <div class="metric-title">
            <i class="fas fa-chart-pie"></i> Modality Distribution
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-top: 15px;">
        {% for modality, count in metrics.medical_data.modality_distribution.items %}
        <div style="text-align: center; padding: 15px; background: var(--secondary-bg); border-radius: 6px;">
            <div style="font-size: 18px; font-weight: 600; color: var(--accent-color);">{{ count }}</div>
            <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">{{ modality }}</div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div style="text-align: center; margin-top: 30px; color: var(--text-secondary); font-size: 12px;">
    <i class="fas fa-clock"></i> Last updated: {{ metrics.timestamp|slice:":19"|date:"Y-m-d H:i:s" }}
    <span style="margin-left: 20px;">
        <i class="fas fa-sync-alt"></i> Auto-refresh: {{ refresh_interval }}s
    </span>
</div>

{% else %}
<div class="metric-card critical">
    <div class="metric-header">
        <div class="metric-title">
            <i class="fas fa-exclamation-triangle"></i> System Error
        </div>
        <div class="metric-status status-critical">Error</div>
    </div>
    
    <div style="color: var(--danger-color); margin-top: 15px;">
        Failed to load system metrics: {{ metrics.error }}
    </div>
</div>
{% endif %}

<script>
// Auto-refresh system metrics
setInterval(function() {
    const indicator = document.getElementById('refreshIndicator');
    indicator.classList.add('show');
    
    fetch('{% url "admin_panel:system_metrics_api" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update page with new metrics
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error refreshing metrics:', error);
        })
        .finally(() => {
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 1000);
        });
}, {{ refresh_interval }}000);

// Manual refresh button
document.addEventListener('keydown', function(e) {
    if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
        e.preventDefault();
        location.reload();
    }
});
</script>
{% endblock %}